name: CI/CD - Calidad y Despliegue Din谩mico

on:
  # 1. PUSH: Se activa en CUALQUIER rama (para que TAREA 1 corra siempre)
  push:
    branches:
      - '**'
  # 2. PR: Se activa en PRs hacia main y development
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - development

jobs:
  # --- TAREA 1: VERIFICACIN DE CDIGO (Lint, Build y Tests) ---
  # ESTA TAREA CORRE SIEMPRE (En cualquier rama)
  build-and-test:
    name: Verificar C贸digo (CI)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del c贸digo
        uses: actions/checkout@v4

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      # 1. Validar estilo de c贸digo
      - name: Ejecutar Lint
        run: npm run lint

      # 2. Tests Unitarios (R谩pidos)
      - name: Ejecutar Tests Unitarios (Vitest)
        run: npm run test -- --run

      # 3. Verificar que el proyecto compila correctamente
      - name: Verificar Build
        run: npm run build

      # 4. Tests E2E (Playwright)
      - name: Instalar Navegadores de Playwright
        run: npx playwright install --with-deps

      - name: Ejecutar Tests E2E (Playwright)
        run: npm run test:e2e

  # --- TAREA 2: DESPLIEGUE INTELIGENTE A VERCEL ---
  # ESTA TAREA SOLO CORRE EN PRs O RAMAS ESPECFICAS
  deploy:
    name: Desplegar a Vercel
    needs: build-and-test
    runs-on: ubuntu-latest
    # CONDICIN MGICA:
    # Ejecutar SOLO SI:
    # 1. Es un Pull Request
    # 2. O es un Push a la rama 'main'
    # 3. O es un Push a la rama 'development'
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/development'))
    steps:
      - name: Checkout del c贸digo
        uses: actions/checkout@v4

      - name: Instalar Vercel CLI
        run: npm install --global vercel@latest

      - name: Ejecutar Despliegue (L贸gica Condicional)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.PROJECT_ID }}
        run: |
          # 1. Definir variables seg煤n el caso
          if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ github.event_name }}" == "push" ]]; then
            echo " MODO: PRODUCCIN (Push a Main detected)"
            VERCEL_ENV="production"
            VERCEL_ARGS="--prod"
          else
            echo " MODO: PREVIEW (Pull Request o Rama Development)"
            VERCEL_ENV="preview"
            VERCEL_ARGS="" 
          fi

          # 2. Bajar configuraci贸n
          vercel pull --yes --environment=$VERCEL_ENV --token=$VERCEL_TOKEN

          # 3. Construir
          vercel build $VERCEL_ARGS --token=$VERCEL_TOKEN

          # 4. Desplegar
          vercel deploy --prebuilt $VERCEL_ARGS --token=$VERCEL_TOKEN

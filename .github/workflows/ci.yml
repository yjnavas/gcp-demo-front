name: CI/CD - Calidad y Despliegue Din谩mico

on:
  # 1. Disparar en Push (Merge) solo a ramas clave
  push:
    branches:
      - '**'
  # 2. Disparar en Pull Requests hacia ramas clave (en cada commit)
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - development

jobs:
  # --- TAREA 1: VERIFICACIN DE CDIGO (Lint, Build y Tests) ---
  build-and-test:
    name: Verificar C贸digo (CI)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del c贸digo
        uses: actions/checkout@v4

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      # 1. Validar estilo de c贸digo
      - name: Ejecutar Lint
        run: npm run lint

      # 2. Tests Unitarios (R谩pidos)
      - name: Ejecutar Tests Unitarios (Vitest)
        run: npm run test -- --run

      # 3. Verificar que el proyecto compila correctamente
      - name: Verificar Build
        run: npm run build

      # 4. Tests E2E (Playwright)
      - name: Instalar Navegadores de Playwright
        run: npx playwright install --with-deps

      - name: Ejecutar Tests E2E (Playwright)
        run: npm run test:e2e

  # --- TAREA 2: DESPLIEGUE INTELIGENTE A VERCEL ---
  deploy:
    name: Desplegar a Vercel
    needs: build-and-test # 隆Seguridad primero! Solo despliega si todo pasa.
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del c贸digo
        uses: actions/checkout@v4

      - name: Instalar Vercel CLI
        run: npm install --global vercel@latest

      - name: Ejecutar Despliegue (L贸gica Condicional)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.PROJECT_ID }}
        run: |
          # 1. Definir variables seg煤n el caso
          if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ github.event_name }}" == "push" ]]; then
            echo " MODO: PRODUCCIN (Push a Main detected)"
            VERCEL_ENV="production"
            VERCEL_ARGS="--prod"
          else
            echo " MODO: PREVIEW (Pull Request o Rama Development)"
            VERCEL_ENV="preview"
            VERCEL_ARGS="" 
          fi

          # 2. Bajar configuraci贸n del entorno correcto
          echo "猬锔 Pulling Vercel Config..."
          vercel pull --yes --environment=$VERCEL_ENV --token=$VERCEL_TOKEN

          # 3. Construir el proyecto (Build)
          echo " Building Project..."
          vercel build $VERCEL_ARGS --token=$VERCEL_TOKEN

          # 4. Desplegar los artefactos construidos
          echo "锔 Deploying..."
          vercel deploy --prebuilt $VERCEL_ARGS --token=$VERCEL_TOKEN

name: CI/CD - Calidad y Despliegue

on:
  push:
    # Se ejecuta en push a cualquier rama
  pull_request:

jobs:
  # TAREA 1: VERIFICACIÓN DE CÓDIGO (Lint, Build y Tests)
  build-and-test:
    name: Verificar Código (CI)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      # 1. Validar estilo de código
      - name: Ejecutar Lint
        run: npm run lint

      # 2. Tests Unitarios (Rápidos)
      # El flag -- --run fuerza a Vitest a correr una vez y cerrar (sin modo watch)
      - name: Ejecutar Tests Unitarios (Vitest)
        run: npm run test -- --run

      # 3. Verificar que el proyecto compila correctamente
      - name: Verificar Build
        run: npm run build

      # 4. Tests E2E (Playwright)
      # Primero instalamos los navegadores necesarios
      - name: Instalar Navegadores de Playwright
        run: npx playwright install --with-deps

      # Ejecutamos las pruebas E2E
      # (Playwright levantará 'npm run dev' automáticamente gracias a tu config)
      - name: Ejecutar Tests E2E (Playwright)
        run: npm run test:e2e

  # TAREA 2: DESPLIEGUE A VERCEL (CD)
  deploy:
    name: Desplegar a Vercel
    needs: build-and-test # <--- IMPORTANTE: Solo despliega si 'build-and-test' pasó exitosamente
    runs-on: ubuntu-latest
    # Solo desplegamos si es un push (evita desplegar PRs abiertas dos veces si usas Vercel Bot)
    if: github.event_name == 'push'
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Desplegar a Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          vercel-args: '--prod'
